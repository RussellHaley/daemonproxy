SHELL = /bin/sh
PERL = perl
POD2MAN = pod2man
GZIP = gzip

all: daemonproxy daemonproxy.1

.SUFFIXES:
.SUFFIXES: .c .o

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
srcdir = @srcdir@/../src
scriptdir = @srcdir@/../scripts
docdir = @srcdir@/../doc
datarootdir = @datarootdir@
sysconfdir = @sysconfdir@
localstatedir = @localstatedir@
runstatedir = $(localstatedir)/run
mandir = @mandir@

daemonproxy_src := fd.c service.c signal.c controller.c Contained_RBTree.c daemonproxy.c log.c strseg.c options.c control-socket.c

CFLAGS = @CFLAGS@ -MMD -MP -O2 -g3 -Wall
CPPFLAGS = @CPPFLAGS@ -I. -I$(srcdir)
LDFLAGS = @LDFLAGS@
LIBS = @LIBS@

-include $(daemonproxy_src:.c=.d)

%.o: $(srcdir)/%.c
	@test -e $(@:.o=.c) || ln -s $< $(@:.o=.c)
	$(CC) -o $@ $(CPPFLAGS) -c $(@:.o=.c) $(CFLAGS)

daemonproxy: $(daemonproxy_src:.c=.o)
	@echo Generating version.c
	@( echo '#include "config.h"'; \
	   echo 'const char *  version_git_tag = "'`git tag | tail -n 1`'";'; \
	   echo 'const int64_t version_build_ts = '`date +%s`';'; \
	   echo 'const char *  version_git_head = "TODO: see Makefile.in";'; \
	) > version.autogen.c
	$(CC) -o version.autogen.o $(CPPFLAGS) -c version.autogen.c $(CFLAGS)
	$(CC) -o $@ $(CPPFLAGS) $^ version.autogen.o $(CFLAGS) $(LDFLAGS) $(LIBS)

controller.o: $(srcdir)/controller_data.autogen.c

$(srcdir)/controller_data.autogen.c: $(srcdir)/controller.c $(scriptdir)/generate_controller_data.pl
	perl $(scriptdir)/generate_controller_data.pl < $< > $@.tmp && mv $@.tmp $@

signal.o: $(srcdir)/signal_data.autogen.c

$(srcdir)/sig_list.txt:
	$(PERL) $(scriptdir)/generate_signal_list.pl > $@.tmp && mv $@.tmp $@

$(srcdir)/signal_data.autogen.c: $(srcdir)/sig_list.txt $(srcdir)/signal.c $(scriptdir)/generate_signal_data.pl
	$(CPP) - - < $< | $(PERL) $(scriptdir)/generate_signal_data.pl > $@.tmp && mv $@.tmp $@

options.o: $(srcdir)/options_data.autogen.c

$(srcdir)/options_data.autogen.c: $(srcdir)/options.c $(scriptdir)/generate_options_data.pl
	$(PERL) $(scriptdir)/generate_options_data.pl < $< > $@.tmp && mv $@.tmp $@

daemonproxy.1: $(docdir)/daemonproxy.head.pod $(srcdir)/options.c $(srcdir)/controller.c $(docdir)/daemonproxy.tail.pod
	cat $^ | $(POD2MAN) --section=1 --center="System Administration tools" --name=DAEMONPROXY --release="daemonproxy "`git tag | tail -n 1 | sed -e s/\.[0-9]*$$//` > $@.tmp && mv $@.tmp $@

daemonproxy.1.gz: daemonproxy.1
	$(GZIP) < $< > $@.tmp && mv $@.tmp $@

install: daemonproxy daemonproxy.1.gz
	$(INSTALL) -m 755 daemonproxy $(DESTDIR)$(bindir)/
	$(INSTALL) -m 644 daemonproxy.1.gz $(DESTDIR)$(mandir)/man1/

dist:
	$(PERL) $(scriptdir)/build_dist_tarball.pl

clean:
	rm -f *.autogen.c
	rm -f *.o
	rm -f *.d
	rm -f daemonproxy
	rm -f daemonproxy.1
	rm -f *.tmp

.PHONY: install test
