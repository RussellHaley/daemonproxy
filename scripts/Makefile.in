SHELL = /bin/sh
PERL = perl
POD2MAN = pod2man
GZIP = gzip
CURRENT_UNIX_TIMESTAMP = $(shell date "+%s")

all: daemonproxy daemonproxy.1

.SUFFIXES:
.SUFFIXES: .c .o

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
srcdir = @srcdir@/../src
scriptdir = @srcdir@
docdir = @srcdir@/../doc
datarootdir = @datarootdir@
sysconfdir = @sysconfdir@
localstatedir = @localstatedir@
runstatedir = $(localstatedir)/run
mandir = @mandir@

daemonproxy_src := fd.c service.c signal.c controller.c Contained_RBTree.c daemonproxy.c log.c strseg.c options.c control-socket.c
autogen_src := $(srcdir)/signal_data.autogen.c $(srcdir)/options_data.autogen.c $(srcdir)/controller_data.autogen.c

CFLAGS = @CFLAGS@ -MMD -MP -O2 -g3 -Wall
CPPFLAGS = @CPPFLAGS@ -I. -I$(srcdir)
LDFLAGS = @LDFLAGS@
LIBS = @LIBS@

-include $(daemonproxy_src:.c=.d)

%.o: $(srcdir)/%.c
	@test -e $(@:.o=.c) || ln -s $< $(@:.o=.c)
	$(CC) -o $@ $(CPPFLAGS) -c $(@:.o=.c) $(CFLAGS)

daemonproxy: $(daemonproxy_src:.c=.o) version.autogen.c
	@if [ -f "$(scriptdir)/version.dist" ]; then \
		cp -f "$(scriptdir)/version.dist" version.autogen.c; \
	else \
		echo Generating version.c; \
		env PROJ_ROOT="$(scriptdir)/.." $(PERL) "$(scriptdir)/generate_version_data.pl" > version.autogen.c.tmp \
			&& mv version.autogen.c.tmp version.autogen.c; \
	fi;
	$(CC) -o version.autogen.o $(CPPFLAGS) -DCURRENT_UNIX_TIMESTAMP=$(CURRENT_UNIX_TIMESTAMP) -c version.autogen.c $(CFLAGS)
	$(CC) -o $@ $(CPPFLAGS) $^ version.autogen.o $(CFLAGS) $(LDFLAGS) $(LIBS)

controller.o: $(srcdir)/controller_data.autogen.c

$(srcdir)/controller_data.autogen.c: $(srcdir)/controller.c $(scriptdir)/generate_controller_data.pl
	perl $(scriptdir)/generate_controller_data.pl < $< > $@.tmp && mv $@.tmp $@

signal.o: $(srcdir)/signal_data.autogen.c

$(srcdir)/sig_list.txt:
	man 7 signal | perl -e 'while (<>) { print "$$_\n" for /(SIG\w+)/g }' | sort -u > $@.tmp && mv $@.tmp $@

$(srcdir)/signal_data.autogen.c: $(srcdir)/sig_list.txt $(srcdir)/signal.c $(scriptdir)/generate_signal_data.pl
	$(PERL) $(scriptdir)/generate_signal_data.pl < $(srcdir)/sig_list.txt > $@.tmp && mv $@.tmp $@

options.o: $(srcdir)/options_data.autogen.c

$(srcdir)/options_data.autogen.c: $(srcdir)/options.c $(scriptdir)/generate_options_data.pl
	$(PERL) $(scriptdir)/generate_options_data.pl < $< > $@.tmp && mv $@.tmp $@

daemonproxy.1: $(docdir)/daemonproxy.head.pod $(srcdir)/options.c $(srcdir)/controller.c $(docdir)/daemonproxy.tail.pod
	cat $^ | $(POD2MAN) --section=1 --center="System Administration tools" --name=DAEMONPROXY --release="daemonproxy "`git tag | tail -n 1 | sed -e s/\.[0-9]*$$//` > $@.tmp && mv $@.tmp $@

daemonproxy.1.gz: daemonproxy.1
	$(GZIP) < $< > $@.tmp && mv $@.tmp $@

install: daemonproxy daemonproxy.1.gz
	$(INSTALL) -m 755 daemonproxy $(DESTDIR)$(bindir)/
	$(INSTALL) -m 644 daemonproxy.1.gz $(DESTDIR)$(mandir)/man1/

dist: $(autogen_src)
	$(PERL) $(scriptdir)/build_dist_tarball.pl

clean:
	rm -f *.autogen.c
	rm -f *.o
	rm -f *.d
	rm -f daemonproxy
	rm -f daemonproxy.1
	rm -f *.tmp

.PHONY: install test
